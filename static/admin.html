<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“ç®¡ç†ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            width: 100%;
            margin: 0;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            border-right: 1px solid #e9ecef;
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pagination input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }
        
        .pagination button {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .pagination button:hover {
            background: #5a6fd8;
        }
        
        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .refresh-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #218838;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status.completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status.running {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status.failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 5px;
        }
        
        .truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .action-btn.restart {
            background: #ffc107;
            color: #212529;
        }
        
        .action-btn.restart:hover {
            background: #e0a800;
        }
        
        .action-btn.edit {
            background: #17a2b8;
            color: white;
        }
        
        .action-btn.edit:hover {
            background: #138496;
        }
        
        .action-btn.delete {
            background: #dc3545;
            color: white;
        }
        
        .action-btn.delete:hover {
            background: #c82333;
        }
        
        .action-btn.reset {
            background: #6f42c1;
            color: white;
        }
        
        .action-btn.reset:hover {
            background: #5a32a3;
        }
        
        .action-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* çˆ¶å­ä»»åŠ¡æ ·å¼ */
        .parent-task {
            background-color: #f8f9fa;
            border-left: 4px solid #28a745;
            font-weight: 600;
        }
        
        .child-task {
            background-color: #fff;
            border-left: 3px solid #6c757d;
        }
        
        .child-task td:first-child {
            color: #6c757d;
        }
        
        /* çˆ¶ä»»åŠ¡ä¿¡æ¯æ˜¾ç¤ºæ ·å¼ */
        .parent-task-info {
            background: #e8f5e8;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }
        
        .parent-task-info .task-id {
            font-weight: bold;
            color: #155724;
        }
        
        .parent-task-info .file-path {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .parent-task-info .status {
            font-size: 11px;
            margin-top: 2px;
        }
        
        /* ä»»åŠ¡ç±»å‹æ ‡ç­¾æ ·å¼ */
        .task-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .task-type-badge.parent {
            background: #d4edda;
            color: #155724;
        }
        
        .task-type-badge.child {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-title {
            font-size: 1.25em;
            font-weight: 600;
            color: #495057;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .alert {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pagination {
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .action-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>çŸ¥è¯†åº“ç®¡ç†ç•Œé¢</h1>
            <p>åˆ†é¡µæŸ¥çœ‹è§£æä»»åŠ¡ã€å‘é‡åŒ–ä»»åŠ¡ã€å¯¹è¯è®°å½•å’Œå‘é‡ç´¢å¼•</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">ä»ªè¡¨æ¿</button>
            <button class="tab" onclick="showTab('parse-tasks')">è§£æä»»åŠ¡</button>
            <button class="tab" onclick="showTab('vector-tasks')">å‘é‡åŒ–ä»»åŠ¡</button>
            <button class="tab" onclick="showTab('chat-sessions')">å¯¹è¯è®°å½•</button>
            <button class="tab" onclick="showTab('vector-indexes')">å‘é‡ç´¢å¼•</button>
        </div>
        
        <div class="content">
            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard" class="tab-content active">
                <div class="controls">
                    <div class="info">
                        <span>ç³»ç»Ÿæ¦‚è§ˆ</span>
                        <button class="refresh-btn" onclick="loadDashboard()">åˆ·æ–°æ•°æ®</button>
                    </div>
                </div>
                <div id="dashboard-content">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
            
            <!-- è§£æä»»åŠ¡ -->
            <div id="parse-tasks" class="tab-content">
                <div class="controls">
                    <div class="info">
                        <span>è§£æä»»åŠ¡åˆ—è¡¨ (æ€»è®¡: <span id="parse-total">0</span>)</span>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <select id="parse-task-type" onchange="loadParseTasks()" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="all">å…¨éƒ¨ä»»åŠ¡</option>
                                <option value="parent">ä»…çˆ¶ä»»åŠ¡</option>
                                <option value="child">ä»…å­ä»»åŠ¡</option>
                            </select>
                            <input type="text" id="parse-filename-filter" placeholder="æŒ‰æ–‡ä»¶åè¿‡æ»¤..." style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px;" onkeyup="filterParseTasks()">
                            <button class="btn btn-primary" onclick="openCreateTaskModal()">åˆ›å»ºè§£æä»»åŠ¡</button>
                            <button class="refresh-btn" onclick="loadParseTasks()">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="pagination">
                        <button onclick="prevPage('parse')" id="parse-prev">ä¸Šä¸€é¡µ</button>
                        <span>æ¯é¡µ</span>
                        <input type="number" id="parse-limit" value="20" min="1" max="100" onchange="loadParseTasks()">
                        <span>æ¡ï¼Œç¬¬</span>
                        <input type="number" id="parse-page" value="1" min="1" onchange="loadParseTasks()">
                        <span>é¡µ</span>
                        <button onclick="nextPage('parse')" id="parse-next">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="parse-table">
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡ID</th>
                                <th>æ–‡ä»¶è·¯å¾„</th>
                                <th>çˆ¶ä»»åŠ¡</th>
                                <th>çŠ¶æ€</th>
                                <th>è¿›åº¦</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>å®Œæˆæ—¶é—´</th>
                                <th>é”™è¯¯ä¿¡æ¯</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="parse-tbody">
                            <tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å‘é‡åŒ–ä»»åŠ¡ -->
            <div id="vector-tasks" class="tab-content">
                <div class="controls">
                    <div class="info">
                        <span>å‘é‡åŒ–ä»»åŠ¡åˆ—è¡¨ (æ€»è®¡: <span id="vector-total">0</span>)</span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="openCreateVectorTaskModal()">åˆ›å»ºå‘é‡åŒ–ä»»åŠ¡</button>
                            <button class="refresh-btn" onclick="loadVectorTasks()">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="pagination">
                        <button onclick="prevPage('vector')" id="vector-prev">ä¸Šä¸€é¡µ</button>
                        <span>æ¯é¡µ</span>
                        <input type="number" id="vector-limit" value="20" min="1" max="100" onchange="loadVectorTasks()">
                        <span>æ¡ï¼Œç¬¬</span>
                        <input type="number" id="vector-page" value="1" min="1" onchange="loadVectorTasks()">
                        <span>é¡µ</span>
                        <button onclick="nextPage('vector')" id="vector-next">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="vector-table">
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡ID</th>
                                <th>è§£æä»»åŠ¡ID</th>
                                <th>ç´¢å¼•ID</th>
                                <th>çŠ¶æ€</th>
                                <th>è¿›åº¦</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>å®Œæˆæ—¶é—´</th>
                                <th>é”™è¯¯ä¿¡æ¯</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="vector-tbody">
                            <tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å¯¹è¯è®°å½• -->
            <div id="chat-sessions" class="tab-content">
                <div class="controls">
                    <div class="info">
                        <span>å¯¹è¯è®°å½•åˆ—è¡¨ (æ€»è®¡: <span id="chat-total">0</span>)</span>
                        <button class="refresh-btn" onclick="loadChatSessions()">åˆ·æ–°</button>
                    </div>
                    <div class="pagination">
                        <button onclick="prevPage('chat')" id="chat-prev">ä¸Šä¸€é¡µ</button>
                        <span>æ¯é¡µ</span>
                        <input type="number" id="chat-limit" value="20" min="1" max="100" onchange="loadChatSessions()">
                        <span>æ¡ï¼Œç¬¬</span>
                        <input type="number" id="chat-page" value="1" min="1" onchange="loadChatSessions()">
                        <span>é¡µ</span>
                        <button onclick="nextPage('chat')" id="chat-next">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="chat-table">
                        <thead>
                            <tr>
                                <th>ä¼šè¯ID</th>
                                <th>ç”¨æˆ·ID</th>
                                <th>ç”¨æˆ·ä¿¡æ¯</th>
                                <th>ç´¢å¼•ID</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æœ€åæ´»åŠ¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="chat-tbody">
                            <tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å‘é‡ç´¢å¼• -->
            <div id="vector-indexes" class="tab-content">
                <div class="controls">
                    <div class="info">
                        <span>å‘é‡ç´¢å¼•åˆ—è¡¨ (æ€»è®¡: <span id="index-total">0</span>)</span>
                        <button class="refresh-btn" onclick="loadVectorIndexes()">åˆ·æ–°</button>
                    </div>
                    <div class="pagination">
                        <button onclick="prevPage('index')" id="index-prev">ä¸Šä¸€é¡µ</button>
                        <span>æ¯é¡µ</span>
                        <input type="number" id="index-limit" value="20" min="1" max="100" onchange="loadVectorIndexes()">
                        <span>æ¡ï¼Œç¬¬</span>
                        <input type="number" id="index-page" value="1" min="1" onchange="loadVectorIndexes()">
                        <span>é¡µ</span>
                        <button onclick="nextPage('index')" id="index-next">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="index-table">
                        <thead>
                            <tr>
                                <th>ç´¢å¼•ID</th>
                                <th>æè¿°</th>
                                <th>åŸå§‹æ–‡ä»¶</th>
                                <th>æ–‡æ¡£æ•°</th>
                                <th>èŠ‚ç‚¹æ•°</th>
                                <th>å‘é‡ç»´åº¦</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="index-tbody">
                            <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡† -->
    <!-- ç¼–è¾‘ç´¢å¼•æè¿°æ¨¡æ€æ¡† -->
    <div id="editIndexModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘ç´¢å¼•æè¿°</h3>
                <span class="close" onclick="closeModal('editIndexModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editIndexId">ç´¢å¼•ID</label>
                    <input type="text" id="editIndexId" readonly>
                </div>
                <div class="form-group">
                    <label for="editIndexDescription">æè¿°</label>
                    <textarea id="editIndexDescription" placeholder="è¯·è¾“å…¥ç´¢å¼•æè¿°"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editIndexModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveIndexDescription()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¡®è®¤åˆ é™¤</h3>
                <span class="close" onclick="closeModal('deleteConfirmModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¸å¯é€†ï¼åˆ é™¤å‘é‡ç´¢å¼•å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ã€‚
                </div>
                <p>ç¡®å®šè¦åˆ é™¤ç´¢å¼• <strong id="deleteIndexId"></strong> å—ï¼Ÿ</p>
                <div class="form-group">
                    <label for="deleteConfirmText">è¯·è¾“å…¥ "ç¡®è®¤åˆ é™¤" æ¥ç¡®è®¤æ“ä½œ</label>
                    <input type="text" id="deleteConfirmText" placeholder="ç¡®è®¤åˆ é™¤">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDeleteIndex()" id="confirmDeleteBtn" disabled>åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <!-- é‡ç½®ä¼šè¯ç´¢å¼•æ¨¡æ€æ¡† -->
    <div id="resetSessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">é‡ç½®ä¼šè¯ç´¢å¼•</h3>
                <span class="close" onclick="closeModal('resetSessionModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="resetSessionId">ä¼šè¯ID</label>
                    <input type="text" id="resetSessionId" readonly>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ–°çš„ç´¢å¼•ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div id="indexCheckboxList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        <!-- ç´¢å¼•å¤é€‰æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="alert alert-info">
                    <strong>è¯´æ˜ï¼š</strong>æ­¤æ“ä½œå°†é‡æ–°ç»‘å®šä¼šè¯çš„ç´¢å¼•ï¼Œè¯·é€‰æ‹©è¦å…³è”çš„ç´¢å¼•ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resetSessionModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="resetSessionIndex()">ç¡®è®¤é‡ç½®</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºè§£æä»»åŠ¡æ¨¡æ€æ¡† -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åˆ›å»ºè§£æä»»åŠ¡</h3>
                <span class="close" onclick="closeModal('createTaskModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="filePath">é€‰æ‹©æ–‡ä»¶æˆ–ç›®å½•</label>
                    <div id="fileTreeContainer" style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto; background: #f9f9f9;">
                        <div class="loading">åŠ è½½æ–‡ä»¶æ ‘ä¸­...</div>
                    </div>
                    <input type="hidden" id="selectedFilePath" value="">
                    <input type="hidden" id="selectedType" value="">
                    <div id="selectedFileDisplay" style="margin-top: 8px; padding: 8px; background: #e9ecef; border-radius: 4px; display: none;">
                        <strong>å·²é€‰æ‹©ï¼š</strong><span id="selectedFileName"></span> <span id="selectedTypeDisplay" style="color: #666; font-size: 12px;"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="parserType">è§£æå™¨ç±»å‹</label>
                    <select id="parserType">
                        <option value="docling">Docling (æ”¯æŒå¤šç§æ ¼å¼)</option>
                        <option value="mineru">MinerU (ä»…æ”¯æŒPDF)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskConfig">é«˜çº§é…ç½® (JSONæ ¼å¼ï¼Œå¯é€‰)</label>
                    <textarea id="taskConfig" placeholder='{
  "ocr_enabled": false,
  "extract_tables": true,
  "extract_images": true,
  "max_workers": 4
}' rows="6"></textarea>
                    <small style="color: #666; font-size: 12px;">
                        å¯é…ç½®å‚æ•°ï¼šocr_enabled(å¯ç”¨OCR), extract_tables(æå–è¡¨æ ¼), extract_images(æå–å›¾ç‰‡), max_workers(å¹¶å‘æ•°ï¼Œä»…MinerU)
                    </small>
                </div>
                
                <div class="alert alert-info">
                    <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        <li><strong>æ–‡ä»¶è§£æï¼š</strong>ä»uploadsç›®å½•æ ‘ä¸­é€‰æ‹©ç‰¹å®šæ–‡ä»¶è¿›è¡Œè§£æ</li>
                        <li><strong>ç›®å½•è§£æï¼š</strong>é€‰æ‹©ç›®å½•å¯è§£æè¯¥ç›®å½•ä¸‹æ‰€æœ‰æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</li>
                    </ul>
                    <strong>è§£æå™¨å¯¹æ¯”ï¼š</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        <li><strong>Doclingï¼š</strong>æ”¯æŒPDFã€Wordã€Excelã€PowerPointã€HTMLç­‰å¤šç§æ ¼å¼ï¼Œé€šç”¨æ€§å¼º</li>
                        <li><strong>MinerUï¼š</strong>ä¸“é—¨é’ˆå¯¹PDFä¼˜åŒ–ï¼Œæ”¯æŒå¤æ‚å¸ƒå±€å’Œå…¬å¼è§£æï¼ŒPDFæ•ˆæœæ›´ä½³</li>
                    </ul>
                    <strong>é…ç½®å‚æ•°ï¼š</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        <li><strong>ocr_enabledï¼š</strong>æ˜¯å¦å¯ç”¨OCRè¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—ï¼ˆé»˜è®¤falseï¼‰</li>
                        <li><strong>extract_tablesï¼š</strong>æ˜¯å¦æå–è¡¨æ ¼ç»“æ„ï¼ˆé»˜è®¤trueï¼‰</li>
                        <li><strong>extract_imagesï¼š</strong>æ˜¯å¦æå–å›¾ç‰‡ä¿¡æ¯ï¼ˆé»˜è®¤trueï¼‰</li>
                        <li><strong>max_workersï¼š</strong>MinerUè§£æå™¨çš„å¹¶å‘çº¿ç¨‹æ•°ï¼ˆé»˜è®¤4ï¼Œä»…å¯¹MinerUæœ‰æ•ˆï¼‰</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createTaskModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createParseTask()">åˆ›å»ºä»»åŠ¡</button>
            </div>
        </div>
    </div>
    
    <!-- é‡æ–°æ‰§è¡Œè§£æä»»åŠ¡æ¨¡æ€æ¡† -->
    <div id="restartParseTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">é‡æ–°æ‰§è¡Œè§£æä»»åŠ¡</h3>
                <span class="close" onclick="closeModal('restartParseTaskModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ä»»åŠ¡ä¿¡æ¯</label>
                    <div id="restartTaskInfo" style="padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 15px;">
                        <div><strong>ä»»åŠ¡IDï¼š</strong><span id="restartTaskId"></span></div>
                        <div><strong>æ–‡ä»¶è·¯å¾„ï¼š</strong><span id="restartFilePath"></span></div>
                        <div><strong>æ–‡ä»¶ç±»å‹ï¼š</strong><span id="restartFileType"></span></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="restartParserType">è§£æå™¨ç±»å‹</label>
                    <select id="restartParserType">
                        <option value="docling">Docling (æ”¯æŒå¤šç§æ ¼å¼)</option>
                        <option value="mineru">MinerU (ä»…æ”¯æŒPDF)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="restartTaskConfig">é«˜çº§é…ç½® (JSONæ ¼å¼ï¼Œå¯é€‰)</label>
                    <textarea id="restartTaskConfig" placeholder='{
  "ocr_enabled": false,
  "extract_tables": true,
  "extract_images": true,
  "max_workers": 4
}' rows="6"></textarea>
                    <small style="color: #666; font-size: 12px;">
                        å¯é…ç½®å‚æ•°ï¼šocr_enabled(å¯ç”¨OCR), extract_tables(æå–è¡¨æ ¼), extract_images(æå–å›¾ç‰‡), max_workers(å¹¶å‘æ•°ï¼Œä»…MinerU)
                    </small>
                </div>
                
                <div class="alert alert-warning">
                    <strong>æ³¨æ„ï¼š</strong>é‡æ–°æ‰§è¡Œä»»åŠ¡å°†ä½¿ç”¨æ–°çš„é…ç½®å‚æ•°é‡æ–°è§£ææ–‡ä»¶ï¼Œä¹‹å‰çš„è§£æç»“æœå°†è¢«è¦†ç›–ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('restartParseTaskModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="executeRestartParseTask()">é‡æ–°æ‰§è¡Œ</button>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºå‘é‡åŒ–ä»»åŠ¡æ¨¡æ€æ¡† -->
    <div id="createVectorTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åˆ›å»ºå‘é‡åŒ–ä»»åŠ¡</h3>
                <span class="close" onclick="closeModal('createVectorTaskModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="vectorTaskTypeFilter">ä»»åŠ¡ç±»å‹ç­›é€‰</label>
                    <select id="vectorTaskTypeFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;" onchange="filterVectorParseTasksByType()">
                        <option value="all">å…¨éƒ¨ä»»åŠ¡</option>
                        <option value="parent">ä»…çˆ¶ä»»åŠ¡</option>
                        <option value="child">ä»…å­ä»»åŠ¡</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="vectorParseTaskId">é€‰æ‹©è§£æä»»åŠ¡</label>
                    <select id="vectorParseTaskId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">è¯·é€‰æ‹©å·²å®Œæˆçš„è§£æä»»åŠ¡...</option>
                    </select>
                    <small style="color: #666; font-size: 12px;">åªæ˜¾ç¤ºçŠ¶æ€ä¸ºCOMPLETEDçš„è§£æä»»åŠ¡</small>
                </div>
                
                <div id="selectedParseTaskInfo" style="display: none; padding: 10px; background: #f8f9fa; border-radius: 4px; margin-top: 10px;">
                    <div><strong>ä»»åŠ¡IDï¼š</strong><span id="selectedParseTaskIdDisplay"></span></div>
                    <div><strong>æ–‡ä»¶è·¯å¾„ï¼š</strong><span id="selectedParseTaskPath"></span></div>
                    <div><strong>å®Œæˆæ—¶é—´ï¼š</strong><span id="selectedParseTaskTime"></span></div>
                </div>
                
                <div class="alert alert-info">
                    <strong>è¯´æ˜ï¼š</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        <li>å‘é‡åŒ–ä»»åŠ¡å°†åŸºäºé€‰æ‹©çš„è§£æä»»åŠ¡åˆ›å»ºå‘é‡ç´¢å¼•</li>
                        <li>åªèƒ½é€‰æ‹©çŠ¶æ€ä¸ºCOMPLETEDçš„è§£æä»»åŠ¡</li>
                        <li>å‘é‡åŒ–ä»»åŠ¡æ²¡æœ‰çˆ¶ä»»åŠ¡IDï¼Œç‹¬ç«‹è¿è¡Œ</li>
                        <li>åˆ›å»ºåå¯åœ¨å‘é‡åŒ–ä»»åŠ¡åˆ—è¡¨ä¸­æŸ¥çœ‹è¿›åº¦</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createVectorTaskModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createVectorTask()">åˆ›å»ºä»»åŠ¡</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æ¶ˆæ¯ -->
    <div id="notification" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1001; max-width: 300px;"></div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentTab = 'dashboard';
        const pageData = {
            parse: { page: 1, limit: 20, total: 0 },
            vector: { page: 1, limit: 20, total: 0 },
            chat: { page: 1, limit: 20, total: 0 },
            index: { page: 1, limit: 20, total: 0 }
        };
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // åŠ è½½å¯¹åº”æ•°æ®
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'parse-tasks':
                    loadParseTasks();
                    break;
                case 'vector-tasks':
                    loadVectorTasks();
                    break;
                case 'chat-sessions':
                    loadChatSessions();
                    break;
                case 'vector-indexes':
                    loadVectorIndexes();
                    break;
            }
        }
        
        // é€šç”¨APIè°ƒç”¨å‡½æ•°
        async function apiCall(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('zh-CN');
        }
        
        // æ ¼å¼åŒ–çŠ¶æ€
        function formatStatus(status) {
            const statusMap = {
                'COMPLETED': 'completed',
                'RUNNING': 'running',
                'FAILED': 'failed',
                'PENDING': 'pending'
            };
            const className = statusMap[status] || 'pending';
            return `<span class="status ${className}">${status}</span>`;
        }
        
        // æˆªæ–­æ–‡æœ¬
        function truncateText(text, maxLength = 50) {
            if (!text) return '-';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        // åŠ è½½ä»ªè¡¨æ¿
        async function loadDashboard() {
            const content = document.getElementById('dashboard-content');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const data = await apiCall('/admin/dashboard?limit=5');
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
                
                // è§£æä»»åŠ¡æ¦‚è§ˆ
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #495057;">è§£æä»»åŠ¡ (æœ€è¿‘5æ¡)</h3>
                        <p style="margin-bottom: 10px;">æ€»è®¡: ${data.data.parse_tasks.total}</p>
                        <div style="max-height: 200px; overflow-y: auto;">
                `;
                
                data.data.parse_tasks.items.forEach(task => {
                    html += `
                        <div style="padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 14px;">
                            <div><strong>${task.task_id}</strong></div>
                            <div>${formatStatus(task.status)} - ${task.progress || 0}%</div>
                            <div style="color: #6c757d;">${truncateText(task.file_path, 30)}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                
                // å‘é‡åŒ–ä»»åŠ¡æ¦‚è§ˆ
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #495057;">å‘é‡åŒ–ä»»åŠ¡ (æœ€è¿‘5æ¡)</h3>
                        <p style="margin-bottom: 10px;">æ€»è®¡: ${data.data.vector_tasks.total}</p>
                        <div style="max-height: 200px; overflow-y: auto;">
                `;
                
                data.data.vector_tasks.items.forEach(task => {
                    html += `
                        <div style="padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 14px;">
                            <div><strong>${task.task_id}</strong></div>
                            <div>${formatStatus(task.status)} - ${task.progress || 0}%</div>
                            <div style="color: #6c757d;">çˆ¶ä»»åŠ¡: ${task.parent_task_id || '-'}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                
                // å¯¹è¯ä¼šè¯æ¦‚è§ˆ
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #495057;">å¯¹è¯ä¼šè¯ (æœ€è¿‘5æ¡)</h3>
                        <p style="margin-bottom: 10px;">æ€»è®¡: ${data.data.chat_sessions.total}</p>
                        <div style="max-height: 200px; overflow-y: auto;">
                `;
                
                data.data.chat_sessions.items.forEach(session => {
                    html += `
                        <div style="padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 14px;">
                            <div><strong>${session.session_id}</strong></div>
                            <div>ç”¨æˆ·: ${session.user_id}</div>
                            <div style="color: #6c757d;">${session.is_active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                
                // å‘é‡ç´¢å¼•æ¦‚è§ˆ
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #495057;">å‘é‡ç´¢å¼• (æœ€è¿‘5æ¡)</h3>
                        <p style="margin-bottom: 10px;">æ€»è®¡: ${data.data.vector_indexes.total}</p>
                        <div style="max-height: 200px; overflow-y: auto;">
                `;
                
                data.data.vector_indexes.items.forEach(index => {
                    html += `
                        <div style="padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 14px;">
                            <div><strong>${index.index_id}</strong></div>
                            <div>æ–‡æ¡£: ${index.document_count || 0}, èŠ‚ç‚¹: ${index.node_count || 0}</div>
                            <div style="color: #6c757d;">${truncateText(index.index_description, 30)}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                html += '</div>';
                
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // åŠ è½½è§£æä»»åŠ¡
        async function loadParseTasks() {
            const limit = document.getElementById('parse-limit').value;
            const page = document.getElementById('parse-page').value;
            const offset = (page - 1) * limit;
            const taskType = document.getElementById('parse-task-type').value;
            
            const tbody = document.getElementById('parse-tbody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>';
            
            try {
                let url = `/admin/parse-tasks?limit=${limit}&offset=${offset}`;
                if (taskType && taskType !== 'all') {
                    url += `&task_type=${taskType}`;
                }
                const data = await apiCall(url);
                
                pageData.parse.total = data.data.total;
                document.getElementById('parse-total').textContent = data.data.total;
                
                let html = '';
                data.data.items.forEach(task => {
                    const canRestart = task.status !== 'RUNNING';
                    
                    // æ„å»ºçˆ¶ä»»åŠ¡ä¿¡æ¯æ˜¾ç¤º
                    let parentTaskInfo = '-';
                    if (task.parent_task_info) {
                        const parentInfo = task.parent_task_info;
                        parentTaskInfo = `
                            <div class="parent-task-info">
                                <div class="task-id">${parentInfo.task_id}</div>
                                <div class="file-path">${truncateText(parentInfo.file_path, 30)}</div>
                                <div class="status">${formatStatus(parentInfo.status)}</div>
                            </div>
                        `;
                    }
                    
                    // ä»»åŠ¡è¡Œæ ·å¼å’Œä»»åŠ¡IDæ˜¾ç¤º
                    let rowClass = '';
                    let taskIdDisplay = task.task_id;
                    let taskTypeBadge = '';
                    
                    if (task.is_parent) {
                        rowClass = 'parent-task';
                        taskIdDisplay = 'ğŸ“ ' + taskIdDisplay;
                        taskTypeBadge = '<span class="task-type-badge parent">çˆ¶ä»»åŠ¡</span>';
                    } else if (task.parent_task_id) {
                        rowClass = 'child-task';
                        taskIdDisplay = '&nbsp;&nbsp;â””â”€ ' + taskIdDisplay;
                        taskTypeBadge = '<span class="task-type-badge child">å­ä»»åŠ¡</span>';
                    }
                    
                    html += `
                        <tr class="${rowClass}">
                            <td class="truncate" title="${task.task_id}">${taskIdDisplay} ${taskTypeBadge}</td>
                            <td class="truncate" title="${task.file_path || '-'}">${truncateText(task.file_path)}</td>
                            <td>${parentTaskInfo}</td>
                            <td>${formatStatus(task.status)}</td>
                            <td>${task.progress || 0}%</td>
                            <td>${formatDate(task.created_at)}</td>
                            <td>${formatDate(task.completed_at)}</td>
                            <td class="truncate" title="${task.error || '-'}">${truncateText(task.error)}</td>
                            <td>
                                <button class="action-btn restart" 
                                        onclick="restartParseTask('${task.task_id}')" 
                                        ${!canRestart ? 'disabled' : ''}
                                        title="${canRestart ? 'é‡æ–°æ‰§è¡Œä»»åŠ¡' : 'ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­'}">
                                    é‡æ–°æ‰§è¡Œ
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="9" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
                updatePagination('parse');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="9" class="error">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            }
        }
        
        // åŠ è½½å‘é‡åŒ–ä»»åŠ¡
        async function loadVectorTasks() {
            const limit = document.getElementById('vector-limit').value;
            const page = document.getElementById('vector-page').value;
            const offset = (page - 1) * limit;
            
            const tbody = document.getElementById('vector-tbody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const data = await apiCall(`/admin/vector-tasks?limit=${limit}&offset=${offset}`);
                
                pageData.vector.total = data.data.total;
                document.getElementById('vector-total').textContent = data.data.total;
                
                let html = '';
                data.data.items.forEach(task => {
                    const canRestart = task.status !== 'RUNNING';
                    html += `
                        <tr>
                            <td class="truncate" title="${task.task_id}">${task.task_id}</td>
                            <td class="truncate" title="${task.parse_task_id || '-'}">${task.parse_task_id || '-'}</td>
                            <td class="truncate" title="${task.index_id || '-'}">${task.index_id || '-'}</td>
                            <td>${formatStatus(task.status)}</td>
                            <td>${task.progress || 0}%</td>
                            <td>${formatDate(task.created_at)}</td>
                            <td>${formatDate(task.completed_at)}</td>
                            <td class="truncate" title="${task.error || '-'}">${truncateText(task.error)}</td>
                            <td>
                                <button class="action-btn restart" 
                                        onclick="restartVectorTask('${task.task_id}')" 
                                        ${!canRestart ? 'disabled' : ''}
                                        title="${canRestart ? 'é‡æ–°æ‰§è¡Œä»»åŠ¡' : 'ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­'}">
                                    é‡æ–°æ‰§è¡Œ
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="9" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
                updatePagination('vector');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="9" class="error">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            }
        }
        
        // åŠ è½½å¯¹è¯ä¼šè¯
        async function loadChatSessions() {
            const limit = document.getElementById('chat-limit').value;
            const page = document.getElementById('chat-page').value;
            const offset = (page - 1) * limit;
            
            const tbody = document.getElementById('chat-tbody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const data = await apiCall(`/admin/chat-sessions?limit=${limit}&offset=${offset}`);
                
                pageData.chat.total = data.data.total;
                document.getElementById('chat-total').textContent = data.data.total;
                
                let html = '';
                data.data.items.forEach(session => {
                    // æ„å»ºç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                    let userInfo = '-';
                    if (session.user_info) {
                        const info = session.user_info;
                        userInfo = `${info.username || info.email || 'æœªçŸ¥ç”¨æˆ·'}`;
                        if (info.email && info.username) {
                            userInfo += ` (${info.email})`;
                        }
                    }
                    
                    html += `
                        <tr>
                            <td class="truncate" title="${session.session_id}">${session.session_id}</td>
                            <td>${session.user_id}</td>
                            <td class="truncate" title="${userInfo}">${truncateText(userInfo, 150)}</td>
                            <td class="truncate" title="${session.index_ids ? session.index_ids.join(', ') : '-'}">${session.index_ids ? truncateText(session.index_ids.join(', ')) : '-'}</td>
                            <td>${session.is_active ? '<span class="status completed">æ´»è·ƒ</span>' : '<span class="status pending">éæ´»è·ƒ</span>'}</td>
                            <td>${formatDate(session.created_at)}</td>
                            <td>${formatDate(session.last_activity)}</td>
                            <td>
                                <button class="action-btn reset" 
                                        onclick="openResetSessionModal('${session.session_id}')" 
                                        title="é‡ç½®ä¼šè¯ç´¢å¼•">
                                    é‡ç½®ç´¢å¼•
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="8" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
                updatePagination('chat');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="8" class="error">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            }
        }
        
        // åŠ è½½å‘é‡ç´¢å¼•
        async function loadVectorIndexes() {
            const limit = document.getElementById('index-limit').value;
            const page = document.getElementById('index-page').value;
            const offset = (page - 1) * limit;
            
            const tbody = document.getElementById('index-tbody');
            tbody.innerHTML = '<tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const data = await apiCall(`/admin/vector-indexes?limit=${limit}&offset=${offset}`);
                
                pageData.index.total = data.data.total;
                document.getElementById('index-total').textContent = data.data.total;
                
                let html = '';
                data.data.items.forEach(index => {
                    html += `
                        <tr>
                            <td class="truncate" title="${index.index_id}">${index.index_id}</td>
                            <td class="truncate" title="${index.index_description || '-'}">${truncateText(index.index_description)}</td>
                            <td class="truncate" title="${index.origin_file_path || '-'}">${truncateText(index.origin_file_path)}</td>
                            <td>${index.document_count || 0}</td>
                            <td>${index.node_count || 0}</td>
                            <td>${index.vector_dimension || '-'}</td>
                            <td>${formatDate(index.created_at)}</td>
                            <td>
                                <button class="action-btn edit" 
                                        onclick="openEditIndexModal('${index.index_id}', '${(index.index_description || '').replace(/'/g, '\\\'')}')" 
                                        title="ç¼–è¾‘ç´¢å¼•æè¿°">
                                    ç¼–è¾‘
                                </button>
                                <button class="action-btn delete" 
                                        onclick="openDeleteConfirmModal('${index.index_id}')" 
                                        title="åˆ é™¤ç´¢å¼•">
                                    åˆ é™¤
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="8" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
                updatePagination('index');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" class="error">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
            }
        }
        
        // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
        function updatePagination(type) {
            const page = parseInt(document.getElementById(`${type}-page`).value);
            const limit = parseInt(document.getElementById(`${type}-limit`).value);
            const total = pageData[type].total;
            const maxPage = Math.ceil(total / limit);
            
            document.getElementById(`${type}-prev`).disabled = page <= 1;
            document.getElementById(`${type}-next`).disabled = page >= maxPage;
        }
        
        // ä¸Šä¸€é¡µ
        function prevPage(type) {
            const pageInput = document.getElementById(`${type}-page`);
            const currentPage = parseInt(pageInput.value);
            if (currentPage > 1) {
                pageInput.value = currentPage - 1;
                switch(type) {
                    case 'parse': loadParseTasks(); break;
                    case 'vector': loadVectorTasks(); break;
                    case 'chat': loadChatSessions(); break;
                    case 'index': loadVectorIndexes(); break;
                }
            }
        }
        
        // ä¸‹ä¸€é¡µ
        function nextPage(type) {
            const pageInput = document.getElementById(`${type}-page`);
            const limit = parseInt(document.getElementById(`${type}-limit`).value);
            const total = pageData[type].total;
            const maxPage = Math.ceil(total / limit);
            const currentPage = parseInt(pageInput.value);
            
            if (currentPage < maxPage) {
                pageInput.value = currentPage + 1;
                switch(type) {
                    case 'parse': loadParseTasks(); break;
                    case 'vector': loadVectorTasks(); break;
                    case 'chat': loadChatSessions(); break;
                    case 'index': loadVectorIndexes(); break;
                }
            }
        }
        
        // æ¨¡æ€æ¡†æ“ä½œ
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            // æ¸…ç©ºè¡¨å•
            if (modalId === 'editIndexModal') {
                document.getElementById('editIndexId').value = '';
                document.getElementById('editIndexDescription').value = '';
            } else if (modalId === 'deleteConfirmModal') {
                document.getElementById('deleteIndexId').textContent = '';
                document.getElementById('deleteConfirmText').value = '';
                document.getElementById('confirmDeleteBtn').disabled = true;
            } else if (modalId === 'resetSessionModal') {
                document.getElementById('resetSessionId').value = '';
                document.getElementById('indexCheckboxList').innerHTML = '';
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
        
        // é€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // é‡æ–°æ‰§è¡Œè§£æä»»åŠ¡
        // æ‰“å¼€é‡æ–°æ‰§è¡Œè§£æä»»åŠ¡æ¨¡æ€æ¡†
        async function restartParseTask(taskId) {
            try {
                // è·å–ä»»åŠ¡è¯¦æƒ…
                const taskResponse = await fetch(`/tasks/parse/${taskId}`);
                const taskData = await taskResponse.json();
                
                if (!taskData.file_path) {
                    showNotification('æ— æ³•è·å–ä»»åŠ¡æ–‡ä»¶è·¯å¾„', 'danger');
                    return;
                }
                
                // å¡«å……æ¨¡æ€æ¡†ä¿¡æ¯
                document.getElementById('restartTaskId').textContent = taskId;
                document.getElementById('restartFilePath').textContent = taskData.file_path;
                
                // åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼ˆæ–‡ä»¶è¿˜æ˜¯ç›®å½•ï¼‰
                const isDirectory = taskData.file_path.endsWith('/') || !taskData.file_path.includes('.');
                document.getElementById('restartFileType').textContent = isDirectory ? 'ç›®å½•' : 'æ–‡ä»¶';
                
                // é¢„å¡«å……å½“å‰é…ç½®
                if (taskData.parser_type) {
                    document.getElementById('restartParserType').value = taskData.parser_type;
                }
                
                // é¢„å¡«å……é…ç½®å‚æ•°
                if (taskData.config) {
                    const configWithoutParserType = { ...taskData.config };
                    delete configWithoutParserType.parser_type; // ç§»é™¤parser_typeï¼Œå› ä¸ºå®ƒæœ‰å•ç‹¬çš„é€‰æ‹©æ¡†
                    
                    if (Object.keys(configWithoutParserType).length > 0) {
                        document.getElementById('restartTaskConfig').value = JSON.stringify(configWithoutParserType, null, 2);
                    } else {
                        document.getElementById('restartTaskConfig').value = '';
                    }
                } else {
                    document.getElementById('restartTaskConfig').value = '';
                }
                
                // å­˜å‚¨ä»»åŠ¡ä¿¡æ¯ä¾›åç»­ä½¿ç”¨
                window.currentRestartTask = {
                    taskId: taskId,
                    filePath: taskData.file_path,
                    isDirectory: isDirectory
                };
                
                // æ‰“å¼€æ¨¡æ€æ¡†
                openModal('restartParseTaskModal');
                
            } catch (error) {
                showNotification('è·å–ä»»åŠ¡ä¿¡æ¯å¤±è´¥: ' + error.message, 'danger');
            }
        }
        
        // æ‰§è¡Œé‡æ–°è§£æä»»åŠ¡
        async function executeRestartParseTask() {
            if (!window.currentRestartTask) {
                showNotification('ä»»åŠ¡ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°æ‰“å¼€', 'danger');
                return;
            }
            
            const parserType = document.getElementById('restartParserType').value;
            const configText = document.getElementById('restartTaskConfig').value;
            
            // è§£æé…ç½®
            let config = { parser_type: parserType };
            if (configText.trim()) {
                try {
                    const userConfig = JSON.parse(configText);
                    config = { ...config, ...userConfig };
                } catch (error) {
                    showNotification('é…ç½®JSONæ ¼å¼é”™è¯¯', 'danger');
                    return;
                }
            }
            
            try {
                let endpoint, body;
                
                if (window.currentRestartTask.isDirectory) {
                    // ç›®å½•è§£æ
                    endpoint = '/parse/directory';
                    body = JSON.stringify({
                        directory_path: window.currentRestartTask.filePath,
                        config: config
                    });
                } else {
                    // æ–‡ä»¶è§£æ
                    endpoint = '/parse/file';
                    body = JSON.stringify({
                        file_path: window.currentRestartTask.filePath,
                        config: config
                    });
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: body
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`è§£æä»»åŠ¡é‡æ–°æ‰§è¡ŒæˆåŠŸï¼Œæ–°ä»»åŠ¡ID: ${result.task_id}`);
                    closeModal('restartParseTaskModal');
                    loadParseTasks();
                    
                    // æ¸…ç†ä¸´æ—¶æ•°æ®
                    window.currentRestartTask = null;
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'é‡æ–°æ‰§è¡Œå¤±è´¥', 'danger');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // é‡æ–°æ‰§è¡Œå‘é‡åŒ–ä»»åŠ¡
        async function restartVectorTask(taskId) {
            try {
                // è·å–å‘é‡åŒ–ä»»åŠ¡è¯¦æƒ…
                const taskResponse = await fetch(`/tasks/vector-store/${taskId}`);
                const taskData = await taskResponse.json();
                
                if (!taskData.parse_task_id) {
                    showNotification('æ— æ³•è·å–è§£æä»»åŠ¡ID', 'danger');
                    return;
                }
                
                // ä½¿ç”¨ç°æœ‰çš„å‘é‡åŒ–æ¥å£é‡æ–°æ‰§è¡Œä»»åŠ¡
                const response = await fetch('/vector-store/build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parse_task_id: taskData.parse_task_id
                    })
                });
                
                if (response.ok) {
                    showNotification('å‘é‡åŒ–ä»»åŠ¡é‡æ–°æ‰§è¡ŒæˆåŠŸ');
                    loadVectorTasks();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'é‡æ–°æ‰§è¡Œå¤±è´¥', 'danger');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // æ‰“å¼€ç¼–è¾‘ç´¢å¼•æ¨¡æ€æ¡†
        function openEditIndexModal(indexId, description) {
            document.getElementById('editIndexId').value = indexId;
            document.getElementById('editIndexDescription').value = description;
            openModal('editIndexModal');
        }
        
        // ä¿å­˜ç´¢å¼•æè¿°
        async function saveIndexDescription() {
            const indexId = document.getElementById('editIndexId').value;
            const description = document.getElementById('editIndexDescription').value;
            
            try {
                const formData = new FormData();
                formData.append('description', description);
                
                const response = await fetch(`/admin/vector-indexes/${indexId}/description`, {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.ok) {
                    showNotification('ç´¢å¼•æè¿°æ›´æ–°æˆåŠŸ');
                    closeModal('editIndexModal');
                    loadVectorIndexes();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'æ›´æ–°å¤±è´¥', 'danger');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // æ‰“å¼€åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function openDeleteConfirmModal(indexId) {
            document.getElementById('deleteIndexId').textContent = indexId;
            openModal('deleteConfirmModal');
        }
        
        // ç›‘å¬åˆ é™¤ç¡®è®¤è¾“å…¥
        document.addEventListener('DOMContentLoaded', function() {
            const deleteConfirmText = document.getElementById('deleteConfirmText');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            
            deleteConfirmText.addEventListener('input', function() {
                confirmDeleteBtn.disabled = this.value !== 'ç¡®è®¤åˆ é™¤';
            });
        });
        
        // ç¡®è®¤åˆ é™¤ç´¢å¼•
        async function confirmDeleteIndex() {
            const indexId = document.getElementById('deleteIndexId').textContent;
            
            try {
                const response = await fetch(`/vector-store/index/${indexId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('ç´¢å¼•åˆ é™¤æˆåŠŸ');
                    closeModal('deleteConfirmModal');
                    loadVectorIndexes();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'åˆ é™¤å¤±è´¥', 'danger');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // æ‰“å¼€é‡ç½®ä¼šè¯ç´¢å¼•æ¨¡æ€æ¡†
        async function openResetSessionModal(sessionId) {
            document.getElementById('resetSessionId').value = sessionId;
            
            // åŠ è½½æ‰€æœ‰å¯ç”¨ç´¢å¼•
            try {
                const response = await fetch('/admin/vector-indexes?limit=1000');
                const result = await response.json();
                
                if (result.success) {
                    const indexList = document.getElementById('indexCheckboxList');
                    indexList.innerHTML = '';
                    
                    result.data.items.forEach(index => {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.style.marginBottom = '8px';
                        checkboxDiv.innerHTML = `
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" value="${index.index_id}" style="margin-right: 8px;">
                                <div>
                                    <strong>${index.index_id}</strong>
                                    <div style="font-size: 12px; color: #666;">${index.index_description || 'æ— æè¿°'}</div>
                                </div>
                            </label>
                        `;
                        indexList.appendChild(checkboxDiv);
                    });
                } else {
                    showNotification('åŠ è½½ç´¢å¼•åˆ—è¡¨å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error loading indexes:', error);
                showNotification('åŠ è½½ç´¢å¼•åˆ—è¡¨å¤±è´¥', 'error');
            }
            
            openModal('resetSessionModal');
        }
        
        // é‡ç½®ä¼šè¯ç´¢å¼•
        async function resetSessionIndex() {
            const sessionId = document.getElementById('resetSessionId').value;
            
            // è·å–é€‰ä¸­çš„ç´¢å¼•
            const checkboxes = document.querySelectorAll('#indexCheckboxList input[type="checkbox"]:checked');
            const selectedIndexIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIndexIds.length === 0) {
                showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç´¢å¼•', 'warning');
                return;
            }
            
            try {
                const formData = new FormData();
                selectedIndexIds.forEach(indexId => {
                    formData.append('index_ids', indexId);
                });
                
                const response = await fetch(`/admin/chat-sessions/${sessionId}/reset-index`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showNotification('ä¼šè¯ç´¢å¼•é‡ç½®æˆåŠŸ');
                    closeModal('resetSessionModal');
                    loadChatSessions();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'é‡ç½®å¤±è´¥', 'danger');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // æ‰“å¼€åˆ›å»ºè§£æä»»åŠ¡æ¨¡æ€æ¡†
        async function openCreateTaskModal() {
            // åŠ è½½uploadsç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨
            await loadUploadFiles();
            openModal('createTaskModal');
        }
        
        // åŠ è½½uploadsç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
        async function loadUploadFiles() {
            try {
                const response = await fetch('/admin/upload-files');
                const result = await response.json();
                
                const container = document.getElementById('fileTreeContainer');
                
                if (result.success && result.data) {
                    const tree = buildFileTree(result.data.files, result.data.directories);
                    container.innerHTML = tree;
                } else {
                    container.innerHTML = '<div style="color: #666;">æš‚æ— æ–‡ä»¶</div>';
                }
            } catch (error) {
                console.error('Error loading upload files:', error);
                container.innerHTML = '<div style="color: #dc3545;">åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥</div>';
            }
        }
        
        // æ„å»ºæ–‡ä»¶æ ‘HTML
        function buildFileTree(files, directories) {
            // æ„å»ºç›®å½•ç»“æ„
            const tree = {};
            
            // æ·»åŠ ç›®å½•
            directories.forEach(dir => {
                const parts = dir.relative_path.split('/');
                let current = tree;
                parts.forEach(part => {
                    if (!current[part]) {
                        current[part] = { type: 'directory', children: {}, path: dir.path };
                    }
                    current = current[part].children;
                });
            });
            
            // æ·»åŠ æ–‡ä»¶
            files.forEach(file => {
                const parts = file.relative_path.split('/');
                const fileName = parts.pop();
                let current = tree;
                
                // å¯¼èˆªåˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•
                parts.forEach(part => {
                    if (!current[part]) {
                        current[part] = { type: 'directory', children: {} };
                    }
                    current = current[part].children;
                });
                
                // æ·»åŠ æ–‡ä»¶
                current[fileName] = {
                    type: 'file',
                    path: file.path,
                    size: file.size,
                    name: file.name
                };
            });
            
            return renderTreeNode(tree, '');
        }
        
        // æ¸²æŸ“æ ‘èŠ‚ç‚¹
        function renderTreeNode(node, prefix) {
            let html = '';
            
            Object.keys(node).sort().forEach(key => {
                const item = node[key];
                const itemId = 'tree_' + Math.random().toString(36).substr(2, 9);
                
                if (item.type === 'directory') {
                    html += `
                        <div style="margin-left: ${prefix.length * 20}px;">
                            <div style="cursor: pointer; padding: 4px; display: flex; align-items: center; border-radius: 3px;" 
                                 onmouseover="this.style.backgroundColor='#e3f2fd'"
                                 onmouseout="this.style.backgroundColor='transparent'">
                                <span id="${itemId}_icon" style="margin-right: 6px; font-family: monospace;" onclick="toggleDirectory('${itemId}')">â–¶</span>
                                <span style="color: #007bff; font-weight: 500;" onclick="selectFile('${item.path}', '${key}', 'directory')">ğŸ“ ${key}</span>
                            </div>
                            <div id="${itemId}_content" style="display: none;">
                                ${renderTreeNode(item.children, prefix + '  ')}
                            </div>
                        </div>
                    `;
                } else {
                    const sizeText = formatFileSize(item.size);
                    html += `
                        <div style="margin-left: ${(prefix.length + 2) * 20}px; padding: 2px 4px; cursor: pointer; border-radius: 3px;" 
                             onclick="selectFile('${item.path}', '${item.name}', 'file')"
                             onmouseover="this.style.backgroundColor='#e3f2fd'"
                             onmouseout="this.style.backgroundColor='transparent'">
                            <span style="color: #28a745;">ğŸ“„ ${key}</span>
                            <span style="color: #666; font-size: 12px; margin-left: 8px;">(${sizeText})</span>
                        </div>
                    `;
                }
            });
            
            return html;
        }
        
        // åˆ‡æ¢ç›®å½•å±•å¼€/æ”¶èµ·
        function toggleDirectory(itemId) {
            const content = document.getElementById(itemId + '_content');
            const icon = document.getElementById(itemId + '_icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }
        
        // é€‰æ‹©æ–‡ä»¶æˆ–ç›®å½•
        function selectFile(filePath, fileName, type) {
            document.getElementById('selectedFilePath').value = filePath;
            document.getElementById('selectedType').value = type;
            document.getElementById('selectedFileName').textContent = fileName;
            
            const typeDisplay = document.getElementById('selectedTypeDisplay');
            typeDisplay.textContent = type === 'file' ? '(æ–‡ä»¶)' : '(ç›®å½•)';
            
            document.getElementById('selectedFileDisplay').style.display = 'block';
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#fileTreeContainer [data-selected="true"]').forEach(el => {
                el.style.backgroundColor = 'transparent';
                el.removeAttribute('data-selected');
            });
            
            // è®¾ç½®å½“å‰é€‰ä¸­çŠ¶æ€
            event.target.style.backgroundColor = '#d4edda';
            event.target.setAttribute('data-selected', 'true');
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        

        
        // åˆ›å»ºè§£æä»»åŠ¡
        async function createParseTask() {
            const selectedFilePath = document.getElementById('selectedFilePath').value;
            const selectedType = document.getElementById('selectedType').value;
            const parserType = document.getElementById('parserType').value;
            const configText = document.getElementById('taskConfig').value;
            
            // éªŒè¯è¾“å…¥
            if (!selectedFilePath) {
                showNotification('è¯·ä»æ–‡ä»¶æ ‘ä¸­é€‰æ‹©è¦è§£æçš„æ–‡ä»¶æˆ–ç›®å½•', 'warning');
                return;
            }
            
            // è§£æé…ç½®
            let config = { parser_type: parserType };
            if (configText.trim()) {
                try {
                    const userConfig = JSON.parse(configText);
                    config = { ...config, ...userConfig };
                } catch (error) {
                    showNotification('é…ç½®JSONæ ¼å¼é”™è¯¯', 'danger');
                    return;
                }
            }
            
            try {
                let endpoint, body;
                
                if (selectedType === 'file') {
                    // å•æ–‡ä»¶è§£æ
                    endpoint = '/parse/file';
                    body = JSON.stringify({
                        file_path: selectedFilePath,
                        config: config
                    });
                } else {
                    // ç›®å½•è§£æ
                    endpoint = '/parse/directory';
                    body = JSON.stringify({
                        directory_path: selectedFilePath,
                        config: config
                    });
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: body
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`è§£æä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ID: ${result.task_id}`);
                    closeModal('createTaskModal');
                    loadParseTasks();
                    
                    // é‡ç½®è¡¨å•
                    document.getElementById('selectedFilePath').value = '';
                    document.getElementById('selectedType').value = '';
                    document.getElementById('selectedFileDisplay').style.display = 'none';
                    document.getElementById('parserType').value = 'docling';
                    document.getElementById('taskConfig').value = '';
                    
                    // æ¸…é™¤æ–‡ä»¶é€‰æ‹©çŠ¶æ€
                    document.querySelectorAll('#fileTreeContainer [data-selected="true"]').forEach(el => {
                        el.style.backgroundColor = 'transparent';
                        el.removeAttribute('data-selected');
                    });
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'åˆ›å»ºä»»åŠ¡å¤±è´¥', 'danger');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // è§£æä»»åŠ¡æ–‡ä»¶åè¿‡æ»¤åŠŸèƒ½
        function filterParseTasks() {
            const filterText = document.getElementById('parse-filename-filter').value.toLowerCase();
            const tbody = document.getElementById('parse-tbody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const filePathCell = row.cells[1]; // æ–‡ä»¶è·¯å¾„åˆ—
                
                if (filePathCell) {
                    const filePath = filePathCell.textContent || filePathCell.innerText;
                    if (filePath.toLowerCase().includes(filterText)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        }
        
        // åˆ‡æ¢å­ä»»åŠ¡æ˜¾ç¤º/éšè—
        function toggleSubTasks(parentTaskId) {
            const subTasks = document.querySelectorAll(`#subtask-${parentTaskId}`);
            const toggleBtn = document.getElementById(`toggle-${parentTaskId}`);
            
            if (subTasks.length > 0) {
                const isHidden = subTasks[0].style.display === 'none';
                
                subTasks.forEach(subTask => {
                    subTask.style.display = isHidden ? '' : 'none';
                });
                
                if (toggleBtn) {
                    const childCount = subTasks.length;
                    toggleBtn.textContent = isHidden ? `[-] ${childCount}ä¸ªå­ä»»åŠ¡` : `[+] ${childCount}ä¸ªå­ä»»åŠ¡`;
                }
            }
        }
        
        // å­˜å‚¨æ‰€æœ‰å·²å®Œæˆçš„è§£æä»»åŠ¡æ•°æ®
        let allCompletedTasks = [];
        
        // åŠ è½½å‘é‡åŒ–ä»»åŠ¡çš„è§£æä»»åŠ¡é€‰é¡¹
        function loadVectorParseTaskOptions(tasks) {
            const select = document.getElementById('vectorParseTaskId');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å·²å®Œæˆçš„è§£æä»»åŠ¡...</option>';
            
            tasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.task_id;
                
                // æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ¼å¼
                let displayText;
                if (task.is_parent) {
                    displayText = `[çˆ¶ä»»åŠ¡] ${task.task_id} - ${task.file_path || 'æœªçŸ¥è·¯å¾„'}`;
                } else if (task.parent_task_info) {
                    displayText = `[å­ä»»åŠ¡] ${task.task_id} - ${task.file_path || 'æœªçŸ¥è·¯å¾„'}`;
                } else {
                    displayText = `[ç‹¬ç«‹ä»»åŠ¡] ${task.task_id} - ${task.file_path || 'æœªçŸ¥è·¯å¾„'}`;
                }
                
                option.textContent = displayText;
                option.dataset.filePath = task.file_path || '';
                option.dataset.completedAt = task.completed_at || '';
                option.dataset.isParent = task.is_parent ? 'true' : 'false';
                select.appendChild(option);
            });
        }
        
        // æ ¹æ®ä»»åŠ¡ç±»å‹ç­›é€‰è§£æä»»åŠ¡
        function filterVectorParseTasksByType() {
            const filterValue = document.getElementById('vectorTaskTypeFilter').value;
            let filteredTasks = [];
            
            switch(filterValue) {
                case 'parent':
                    filteredTasks = allCompletedTasks.filter(task => task.is_parent);
                    break;
                case 'child':
                    filteredTasks = allCompletedTasks.filter(task => task.parent_task_info);
                    break;
                case 'all':
                default:
                    filteredTasks = allCompletedTasks;
                    break;
            }
            
            loadVectorParseTaskOptions(filteredTasks);
            
            // æ¸…é™¤å·²é€‰æ‹©çš„ä»»åŠ¡ä¿¡æ¯
            document.getElementById('selectedParseTaskInfo').style.display = 'none';
        }
        
        // æ‰“å¼€åˆ›å»ºå‘é‡åŒ–ä»»åŠ¡æ¨¡æ€æ¡†
        async function openCreateVectorTaskModal() {
            try {
                // åŠ è½½å·²å®Œæˆçš„è§£æä»»åŠ¡
                const data = await apiCall('/admin/parse-tasks?limit=1000&offset=0');
                allCompletedTasks = data.data.items.filter(task => task.status === 'COMPLETED');
                
                // é‡ç½®ç­›é€‰å™¨
                document.getElementById('vectorTaskTypeFilter').value = 'all';
                
                // åˆå§‹åŠ è½½æ‰€æœ‰ä»»åŠ¡
                loadVectorParseTaskOptions(allCompletedTasks);
                
                // æ·»åŠ é€‰æ‹©å˜åŒ–äº‹ä»¶
                const select = document.getElementById('vectorParseTaskId');
                select.onchange = function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const infoDiv = document.getElementById('selectedParseTaskInfo');
                    
                    if (this.value) {
                        document.getElementById('selectedParseTaskIdDisplay').textContent = this.value;
                        document.getElementById('selectedParseTaskPath').textContent = selectedOption.dataset.filePath;
                        document.getElementById('selectedParseTaskTime').textContent = formatDate(selectedOption.dataset.completedAt);
                        infoDiv.style.display = 'block';
                    } else {
                        infoDiv.style.display = 'none';
                    }
                };
                
                openModal('createVectorTaskModal');
            } catch (error) {
                showNotification('åŠ è½½è§£æä»»åŠ¡å¤±è´¥: ' + error.message, 'danger');
            }
        }
        
        // åˆ›å»ºå‘é‡åŒ–ä»»åŠ¡
        async function createVectorTask() {
            const parseTaskId = document.getElementById('vectorParseTaskId').value;
            
            if (!parseTaskId) {
                showNotification('è¯·é€‰æ‹©ä¸€ä¸ªè§£æä»»åŠ¡', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/vector-store/build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parse_task_id: parseTaskId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`å‘é‡åŒ–ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ID: ${result.task_id}`);
                    closeModal('createVectorTaskModal');
                    loadVectorTasks();
                    
                    // é‡ç½®è¡¨å•
                    document.getElementById('vectorParseTaskId').value = '';
                    document.getElementById('selectedParseTaskInfo').style.display = 'none';
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'åˆ›å»ºå‘é‡åŒ–ä»»åŠ¡å¤±è´¥', 'danger');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            
            // æ·»åŠ ä»»åŠ¡ç±»å‹ç­›é€‰äº‹ä»¶ç›‘å¬å™¨
            const parseTaskTypeSelect = document.getElementById('parse-task-type');
            if (parseTaskTypeSelect) {
                parseTaskTypeSelect.addEventListener('change', function() {
                    // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    document.getElementById('parse-page').value = 1;
                    loadParseTasks();
                });
            }
        });
    </script>
</body>
</html>